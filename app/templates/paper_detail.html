{% extends "base.html" %}
{% block title %}{{ paper.title_zh or paper.title_en }}{% endblock %}
{% block content %}
<style>
  .logo-btn {
    padding: 8px 12px;
  }
  .logo-icon { height: 18px; width: 18px; display: block; }
</style>
<div class="row g-4">
  <div class="col-lg-8">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div>
            <p class="text-muted mb-1">{{ paper.category or 'Unknown category' }}</p>
            <h1 class="h4 mb-1">{{ paper.title_zh or paper.title_en }}</h1>
            <p class="text-muted fst-italic">{{ paper.title_en }}</p>
            {% if paper.similarity is not none %}
            {% set sim = paper.similarity %}
            {% set sim_class = 'bg-success-subtle text-success' %}
            {% if sim < 0.7 %}{% set sim_class = 'bg-warning-subtle text-dark' %}{% endif %}
            {% if sim < 0.4 %}{% set sim_class = 'bg-secondary-subtle text-secondary' %}{% endif %}
            <span class="badge rounded-pill {{ sim_class }} px-3 py-2">{{ "%.2f"|format(sim) }}</span>
            {% endif %}
          </div>
          {% if paper.tags %}
            <div class="d-flex flex-wrap gap-1">
              {% for tag in paper.tags %}
                <span class="badge rounded-pill text-bg-light border me-1">{{ tag }}</span>
              {% endfor %}
            </div>
          {% endif %}
        </div>
        <div class="mt-3">
          <h6 class="text-muted">摘要 (中文)</h6>
          <p>{{ paper.abstract_zh or '暂无翻译' }}</p>
          <h6 class="text-muted mt-3">Abstract (English)</h6>
          <p>{{ paper.abstract_en }}</p>
          {% if paper.comment %}
          <h6 class="text-muted mt-3">Comment</h6>
          <p class="text-muted">{{ paper.comment }}</p>
          {% endif %}
        </div>
        <div class="mt-3 d-flex flex-wrap gap-2">
          {% if paper.github_url %}
            <a class="btn btn-dark d-flex align-items-center justify-content-center logo-btn" href="{{ paper.github_url }}" target="_blank" rel="noopener">
              <svg class="logo-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path fill="currentColor" d="M12 1C5.923 1 1 5.923 1 12c0 4.867 3.149 8.979 7.521 10.436.55.096.756-.233.756-.522 0-.262-.013-1.128-.013-2.049-2.764.509-3.479-.674-3.699-1.292-.124-.317-.66-1.293-1.127-1.554-.385-.207-.936-.715-.014-.729.866-.014 1.485.797 1.691 1.128.99 1.663 2.571 1.196 3.204.907.096-.715.385-1.196.701-1.471-2.448-.275-5.005-1.224-5.005-5.432 0-1.196.426-2.186 1.128-2.956-.111-.275-.496-1.402.11-2.915 0 0 .921-.288 3.024 1.128a10.193 10.193 0 0 1 2.75-.371c.936 0 1.871.123 2.75.371 2.104-1.43 3.025-1.128 3.025-1.128.605 1.513.221 2.64.111 2.915.701.77 1.127 1.747 1.127 2.956 0 4.222-2.571 5.157-5.019 5.432.399.344.743 1.004.743 2.035 0 1.471-.014 2.654-.014 3.025 0 .289.206.632.756.522C19.851 20.979 23 16.854 23 12c0-6.077-4.922-11-11-11Z" />
              </svg>
              <span class="visually-hidden">GitHub</span>
            </a>
          {% endif %}
          <a class="btn btn-primary d-flex align-items-center justify-content-center logo-btn" href="https://arxiv.org/abs/{{ paper.id }}" target="_blank" rel="noopener">
            <img src="{{ url_for('static', filename='logos/arxiv.png') }}" alt="arXiv" class="logo-icon">
            <span class="visually-hidden">arXiv</span>
          </a>
          <a class="btn btn-outline-primary d-flex align-items-center justify-content-center logo-btn" href="https://www.alphaxiv.org/abs/{{ paper.id }}" target="_blank" rel="noopener">
            <img src="{{ url_for('static', filename='logos/alphaxiv.ico') }}" alt="alphaXiv" class="logo-icon">
            <span class="visually-hidden">alphaXiv</span>
          </a>
          <a class="btn btn-outline-dark" href="https://papers.cool/arxiv/{{ paper.id }}" target="_blank" rel="noopener">paper.cool</a>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    {% if paper.summary_zh or paper.summary_en %}
      <div class="alert alert-secondary shadow-sm mb-3">
        <strong>一句话总结：</strong>
        {% if paper.summary_zh %}
          <div class="mt-1">{{ paper.summary_zh }}</div>
        {% endif %}
        {% if paper.summary_en %}
          <div class="mt-1 text-muted small">EN: {{ paper.summary_en }}</div>
        {% endif %}
      </div>
    {% endif %}
    <div class="card shadow-sm border-0 mb-3">
      <div class="card-body">
        <h6 class="text-muted">Favorites</h6>
        <form method="post" action="{{ url_for('feed.add_to_favorites') }}">
          <input type="hidden" name="paper_id" value="{{ paper.id }}">
          <input type="hidden" name="return_to" value="{{ request.path }}">
          {% if favorites %}
            <div class="mb-2 small text-muted">Select existing folders:</div>
            <div class="mb-3">
              {% for fav in favorites %}
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="favorite_ids" value="{{ fav['id'] }}" id="fav{{ fav['id'] }}" {% if fav['has_paper'] or fav['is_top'] or fav.get('auto_checked') %}checked{% endif %}>
                  <label class="form-check-label" for="fav{{ fav['id'] }}">
                    {{ fav['name'] }}
                    {% if fav['similarity'] is not none %}
                      <span class="text-muted small">({{ '%.2f'|format(fav['similarity']) }})</span>
                    {% endif %}
                  </label>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted small">No favorites yet. Create one below.</p>
          {% endif %}
          <div class="mb-2">
            <label for="new_favorite_name" class="form-label">New folder</label>
            <div class="input-group">
              <input class="form-control" type="text" id="new_favorite_name" name="new_favorite_name" placeholder="e.g. Vision 2025">
              <button class="btn btn-outline-primary" type="submit" id="btnNewFavorite" formaction="{{ url_for('feed.create_favorite') }}">New</button>
            </div>
            <input type="hidden" name="return_to" value="{{ request.path }}">
          </div>
          <button class="btn btn-primary w-100" type="submit">Save to favorites</button>
        </form>
      </div>
    </div>
    {% if paper.image_url %}
      <div class="card shadow-sm border-0 mb-3">
        <img class="card-img-top" src="{{ paper.thumb_full_url or paper.image_url }}" alt="Thumbnail">
      </div>
    {% endif %}
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <h6 class="text-muted">Metadata</h6>
        <p class="mb-1"><strong>arXiv ID:</strong> {{ paper.id }}</p>
        <p class="mb-1"><strong>Published:</strong> {{ paper.pub_date }}</p>
        {% if paper.similarity is not none %}
          <p class="mb-1"><strong>相似度:</strong> {{ "%.2f"|format(paper.similarity) }}</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
<script>
  (() => {
    const newFavBtn = document.getElementById('btnNewFavorite');
    const newFavInput = document.getElementById('new_favorite_name');
    if (newFavBtn && newFavInput) {
      newFavBtn.addEventListener('click', () => {
        // Clear after submit click to avoid stale text on return
        setTimeout(() => { newFavInput.value = ''; }, 0);
      });
    }
  })();
</script>
{% endblock %}
